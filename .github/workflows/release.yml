name: Release

on:
  push:
    tags:
      - 'v*.*.*'

jobs:
  release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install frontend dependencies
      run: |
        cd frontend
        Get-ChildItem
        Get-Content package.json -TotalCount 20
        npm ci
      env:
        CI: true

    - name: Install backend dependencies
      run: |
        cd backend
        Get-ChildItem
        Get-Content requirements.txt -TotalCount 10
        python -m venv venv
        .\venv\Scripts\activate
        python -m pip install --upgrade pip
        pip install wheel setuptools
        pip install -r requirements.txt
        pip install pyinstaller
        pip install wheel

    - name: Build backend executable
      run: |
        cd backend
        .\venv\Scripts\activate
        
        # Create PyInstaller spec file
        echo '# -*- mode: python ; coding: utf-8 -*-' > backend.spec
        echo '' >> backend.spec
        echo 'import os' >> backend.spec
        echo 'from pathlib import Path' >> backend.spec
        echo '' >> backend.spec
        echo '# Get the current directory (backend folder)' >> backend.spec
        echo 'current_dir = Path.cwd()' >> backend.spec
        echo '# Get the parent directory (reactui folder)' >> backend.spec
        echo 'parent_dir = current_dir.parent' >> backend.spec
        echo '' >> backend.spec
        echo 'a = Analysis(' >> backend.spec
        echo '    ['run.py'],' >> backend.spec
        echo '    pathex=[str(current_dir), str(parent_dir)],' >> backend.spec
        echo '    binaries=[],' >> backend.spec
        echo '    datas=[' >> backend.spec
        echo '        # Include config files' >> backend.spec
        echo "        ('.env', '.')," >> backend.spec
        echo "        ('app', 'app')," >> backend.spec
        echo "        (str(parent_dir / 'crypto'), 'crypto')," >> backend.spec
        echo '    ],' >> backend.spec
        echo '    hiddenimports=[' >> backend.spec
        echo "        'flask', 'flask_cors', 'werkzeug', 'jinja2'," >> backend.spec
        echo "        'pymongo', 'cryptography', 'cryptography.hazmat'," >> backend.spec
        echo "        'cryptography.hazmat.primitives', 'boto3', 'python-dotenv'," >> backend.spec
        echo "        'requests', 'werkzeug.security', 'datetime', 'pathlib'," >> backend.spec
        echo "        'os', 'sys', 'json', 'uuid', 'hashlib', 'base64', 'secrets'," >> backend.spec
        echo '    ],' >> backend.spec
        echo '    hookspath=[],' >> backend.spec
        echo '    hooksconfig={},' >> backend.spec
        echo '    runtime_hooks=[],' >> backend.spec
        echo '    excludes=[],' >> backend.spec
        echo '    win_no_prefer_redirects=False,' >> backend.spec
        echo '    win_private_assemblies=False,' >> backend.spec
        echo '    cipher=None,' >> backend.spec
        echo '    noarchive=False,' >> backend.spec
        echo ')' >> backend.spec
        echo '' >> backend.spec
        echo 'pyz = PYZ(a.pure, a.zipped_data, cipher=None)' >> backend.spec
        echo '' >> backend.spec
        echo 'exe = EXE(' >> backend.spec
        echo '    pyz,' >> backend.spec
        echo '    a.scripts,' >> backend.spec
        echo '    a.binaries,' >> backend.spec
        echo '    a.zipfiles,' >> backend.spec
        echo '    a.datas,' >> backend.spec
        echo '    [],' >> backend.spec
        echo "    name='sentra-backend'," >> backend.spec
        echo '    debug=False,' >> backend.spec
        echo '    bootloader_ignore_signals=False,' >> backend.spec
        echo '    strip=False,' >> backend.spec
        echo '    upx=True,' >> backend.spec
        echo '    upx_exclude=[],' >> backend.spec
        echo '    runtime_tmpdir=None,' >> backend.spec
        echo '    console=True,' >> backend.spec
        echo '    disable_windowed_traceback=False,' >> backend.spec
        echo '    argv_emulation=False,' >> backend.spec
        echo '    target_arch=None,' >> backend.spec
        echo '    codesign_identity=None,' >> backend.spec
        echo '    entitlements_file=None,' >> backend.spec
        echo '    icon=None,' >> backend.spec
        echo ')' >> backend.spec
        
        pyinstaller --clean backend.spec

    - name: Copy backend to frontend
      run: |
        mkdir frontend\resources -Force
        copy backend\dist\sentra-backend.exe frontend\resources\

    - name: Build and publish Electron app
      run: |
        cd frontend
        npm run build-electron-win
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          frontend/dist-electron/Sentra Setup *.exe
          frontend/dist-electron/Sentra-Portable-*.exe
          frontend/dist-electron/latest.yml
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}